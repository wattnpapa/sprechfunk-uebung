<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprechfunk √úbungsgenerator</title>

    <!-- Bootstrap f√ºr Styling -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Richtige FontAwesome Einbindung -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- jsPDF f√ºr PDF-Erstellung -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- AutoTable f√ºr saubere Tabellen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas f√ºr HTML-to-Image-Rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            max-width: 98%;
            margin: auto;
        }

        .table th,
        .table td {
            text-align: left;
            vertical-align: middle;
        }

        .underline {
            text-decoration: underline;
            font-weight: bold;
        }

        .github-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #24292e;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

        .github-badge img {
            width: 20px;
            height: 20px;
            margin-right: 8px;
        }

        .github-badge:hover {
            background-color: #444c56;
        }
    </style>
</head>

<body>

    <a href="https://github.com/wattnpapa/sprechfunk-uebung" target="_blank" class="github-badge">
        <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" alt="GitHub Logo">
        <span>Projekt auf GitHub</span>
    </a>

    <div class="container mt-4">
        <h2 class="text-primary mb-3"><i class="fas fa-broadcast-tower"></i> Sprechfunk √úbungsgenerator</h2>

        <div class="row">
            <!-- Kopfdaten (links) -->
            <div class="col-md-6">
                <h4 class="mt-4"><i class="fas fa-info-circle"></i> Kopfdaten</h4>

                <div class="mb-3">
                    <label class="form-label">Datum der √úbung:</label>
                    <input type="date" class="form-control" id="datum" value="2025-03-29">
                </div>

                <div class="mb-3">
                    <label class="form-label">Name der √úbung:</label>
                    <input type="text" class="form-control" id="nameDerUebung">
                </div>

                <div class="mb-3">
                    <label class="form-label">Rufgruppe der √úbung:</label>
                    <input type="text" class="form-control" id="rufgruppe">
                </div>

                <div class="mb-3">
                    <label class="form-label">Funkrufname der √úbungsleitung:</label>
                    <input type="text" class="form-control" id="leitung">
                </div>

                <h4 class="mt-4"><i class="fas fa-comment"></i> Einstellungen</h4>

                <div class="row">
                    <!-- Anzahl Funkspr√ºche pro Teilnehmer -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Funkspr√ºche pro Teilnehmer:</label>
                        <input type="number" class="form-control" id="spruecheProTeilnehmer" min="1" value="50"
                            oninput="updateVerteilung()">
                    </div>

                    <!-- Nachrichten an alle -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">% an Alle:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="prozentAnAlle" min="0" max="100" value="10"
                                oninput="updateAbsolute('alle')">
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Ergibt <span id="calcAnAlle">5</span> Nachrichten</small>
                        <input type="hidden" id="spruecheAnAlle" value="5">
                    </div>

                    <!-- Nachrichten an mehrere -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">% an Mehrere:</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="prozentAnMehrere" min="0" max="100" value="5"
                                oninput="updateAbsolute('mehrere')">
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">Ergibt <span id="calcAnMehrere">2</span> Nachrichten</small>
                        <input type="hidden" id="spruecheAnMehrere" value="2">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Funkspr√ºche verwenden:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="useCustomList"
                            onchange="toggleFunkspruchInput()">
                        <label class="form-check-label" for="useCustomList">
                            Eigene Funkspruchliste hochladen
                        </label>
                    </div>
                </div>

                <div class="mb-3" id="fileUploadContainer" style="display: none;">
                    <label class="form-label">Funkspr√ºche hochladen:</label>
                    <input type="file" class="form-control" id="funksprueche" accept=".txt">
                </div>

                <div class="mb-3">
                    <input type="radio" id="keineLoesungswoerter" name="loesungswortOption" checked onclick="renderTeilnehmer()">
                    <label for="keineLoesungswoerter">Keine L√∂sungsw√∂rter</label>
                
                    <input type="radio" id="zentralLoesungswort" name="loesungswortOption" onclick="renderTeilnehmer()">
                    <label for="zentralLoesungswort">Zentrales L√∂sungswort</label>
                
                    <input type="radio" id="individuelleLoesungswoerter" name="loesungswortOption" onclick="renderTeilnehmer()">
                    <label for="individuelleLoesungswoerter">Individuelle L√∂sungsw√∂rter</label>
                
                    <div id="zentralLoesungswortContainer" style="display: none;">
                        <input type="text" id="zentralLoesungswortInput" class="form-control mt-2" placeholder="Zentrales L√∂sungswort" readonly>
                    </div>
                </div>
                
                <button id="shuffleButton" class="btn btn-primary" onclick="shuffleLoesungswoerter()" style="display: none;">
                    üîÄ L√∂sungsw√∂rter Zuf√§llig neu zuweisen
                </button>

            </div>

            <!-- Wrapper f√ºr Teilnehmerliste -->
            <div class="col-md-6">
                <h4 class="text-primary"><i class="fas fa-users"></i> Teilnehmerverwaltung</h4>

                <!-- Diese Zeile sorgt f√ºr Flexbox-Layout -->
                <div class="row" id="teilnehmer-container">
                    <!-- Hier wird per JS die Tabelle eingef√ºgt -->
                </div>
            </div>
        </div>

        <button class="btn btn-success w-100 mt-4" onclick="startUebung()">
            <i class="fas fa-cogs"></i> √úbung generieren
        </button>

        <div id="output-container" style="display: none;">

            <h4 class="mt-4"><i class="fas fa-file-alt"></i> Vorschau der generierten Seiten</h4>

            <div class="text-center mb-3">
                <button class="btn btn-secondary" onclick="changePage(-1)">‚¨Ö Zur√ºck</button>
                <span id="current-page">Seite 1 / 1</span>
                <button class="btn btn-secondary" onclick="changePage(1)">Weiter ‚û°</button>
                <button class="btn btn-danger" onclick="generatePDFs()">
                    <i class="fas fa-file-pdf"></i> Teilnehmer PDFs generieren
                </button>
                <button class="btn btn-info" onclick="generateInstructorPDF()">
                    <i class="fas fa-user-tie"></i> √úbungsleitung PDF erzeugen
                </button>
            </div>

            <iframe id="resultFrame" style="width: 100%; height: 900px; border: 1px solid #ccc;"></iframe>
        </div>
    </div>

    <script>
        let teilnehmerListe = [
            "Heros Oldenburg 16/11",
            "Heros Oldenburg 18/13",
            "Heros Oldenburg 86/25",
            "Florian Wesermarsch 14/23/4",
            "Akkon Oldenburg 12/67",
            "Rotkreuz Schortens 32/54",
            "Heros Wilhemshaven 22/51",
            "Heros Wilhemshaven 21/10",
            "Heros Leer 21/10",
            "Heros Emden 21/10"
        ];

        const predefinedLoesungswoerter = [
            "Funkverkehr", "Rettungswagen", "Notruf", "Blaulicht", "Funkdisziplin",
            "Einsatzleitung", "Mikrofon", "Durchsage", "Sprechgruppe", "Digitalfunk",
            "Frequenz", "Funkstille", "Antennenmast", "Feuerwehr", "Katastrophenschutz",
            "Alarmierung", "Fernmelder", "Kommunikation", "Verst√§ndigung", "Sicherheitszone",
            "Einsatzplan", "Koordination", "Funkger√§t", "Signalst√§rke", "Verbindung",
            "Repeater", "Einsatzbesprechung", "Lautst√§rke", "Funkkanal", "Empfang",
            "Relaisstation", "Funkraum", "Gruppenruf", "R√ºckmeldung", "Einsatzgebiet",
            "Wellenl√§nge", "√úbertragung", "Ausfallsicherheit", "Rescue", "Einsatzwagen"
        ];

        let spruecheProTeilnehmer = 50;
        let spruecheAnAlle = 3;
        let spruecheAnMehrere = 2;

        let leitung = "Heros Wind 10";
        let rufgruppe = "T_OL_GOLD-1";
        let nameDerUebung = "Sprechfunk√ºbung Blauer Wind 2025";

        let datum;
        let natoDate;

        let jsonUebungsDaten;
        let htmlUebungsDaten = [];
        let loesungswoerter = {};

        let currentPageIndex = 0;

        function updateVerteilung() {
            updateAbsolute('alle');
            updateAbsolute('mehrere');
        }

        function updateAbsolute(type) {
            let total = Number(document.getElementById("spruecheProTeilnehmer").value);
            let percentInput = document.getElementById(`prozentAn${capitalize(type)}`);
            let calcSpan = document.getElementById(`calcAn${capitalize(type)}`);
            let hiddenInput = document.getElementById(`spruecheAn${capitalize(type)}`);

            let percentageValue = Number(percentInput.value);
            let absoluteValue = Math.round((percentageValue / 100) * total);

            calcSpan.textContent = absoluteValue;
            hiddenInput.value = absoluteValue;
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function renderInitData() {
            document.getElementById("spruecheProTeilnehmer").value = spruecheProTeilnehmer;
            document.getElementById("spruecheAnAlle").value = spruecheAnAlle;
            document.getElementById("spruecheAnMehrere").value = spruecheAnMehrere;
            document.getElementById("leitung").value = leitung;
            document.getElementById("rufgruppe").value = rufgruppe;
            document.getElementById("nameDerUebung").value = nameDerUebung;

            renderTeilnehmer();
        }

        function renderTeilnehmer(triggerShuffle = true) {
            const container = document.getElementById("teilnehmer-container");
            container.innerHTML = ""; // Vorherigen Inhalt leeren

            let option = document.querySelector('input[name="loesungswortOption"]:checked')?.id;
            let isZentral = option === "zentralLoesungswort";
            let isIndividuell = option === "individuelleLoesungswoerter";

            // Zeige/verstecke das zentrale L√∂sungswort-Eingabefeld
            document.getElementById("zentralLoesungswortContainer").style.display = isZentral ? "block" : "none";

            // Zeige/verstecke den Button f√ºr zuf√§llige Verteilung
            document.getElementById("shuffleButton").style.display = (isZentral || isIndividuell) ? "block" : "none";

            // **Erstelle die Tabelle mit dynamischer Spalte f√ºr L√∂sungsw√∂rter**
            container.innerHTML = `
                <table class="table table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Teilnehmer</th>
                            ${isIndividuell ? "<th id='loesungswortHeader'>L√∂sungswort</th>" : ""}
                            <th style="width: 50px;">Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="teilnehmer-body"></tbody>
                </table>
            `;

            // **Jetzt erst das `tbody` abrufen**
            const tbody = document.getElementById("teilnehmer-body");

            if (!tbody) {
                console.error("Fehler: tbody-Element konnte nicht gefunden werden!");
                return;
            }

            // **F√ºge die Teilnehmer als Tabellenzeilen hinzu**
            teilnehmerListe.forEach((teilnehmer, index) => {
                const row = document.createElement("tr");

                let loesungswortInput = "";
                if (isIndividuell) {
                    let wort = loesungswoerter[teilnehmer] || "";
                    loesungswortInput = `<td><input type="text" class="form-control" id="loesungswort-${index}" value="${wort}" placeholder="L√∂sungswort" readonly></td>`;
                }

                row.innerHTML = `
                    <td><input type="text" class="form-control" value="${teilnehmer}" oninput="updateTeilnehmer(${index}, this.value)"></td>
                    ${loesungswortInput}
                    <td><button class="btn btn-danger btn-sm" onclick="removeTeilnehmer(${index})"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(row);
            });

            // Falls `renderTeilnehmer` von einer Benutzerinteraktion kommt, neu verteilen
            if (triggerShuffle) {
                shuffleLoesungswoerter();
            }
        }

        function updateTeilnehmer(index, value) {
            teilnehmerListe[index] = value;
        }

        function addTeilnehmer() {
            teilnehmerListe.push("");
            renderTeilnehmer();
        }

        function removeTeilnehmer(index) {
            teilnehmerListe.splice(index, 1);
            renderTeilnehmer();
        }

        function toggleFunkspruchInput() {
            const useCustomList = document.getElementById("useCustomList").checked;
            document.getElementById("fileUploadContainer").style.display = useCustomList ? "block" : "none";
        }

        function startUebung() {
            const useCustomList = document.getElementById("useCustomList").checked;
            const file = document.getElementById("funksprueche").files[0];

            spruecheProTeilnehmer = Number(document.getElementById("spruecheProTeilnehmer").value);
            spruecheAnAlle = Number(document.getElementById("spruecheAnAlle").value);
            spruecheAnMehrere = Number(document.getElementById("spruecheAnMehrere").value);
            leitung = document.getElementById("leitung").value;
            rufgruppe = document.getElementById("rufgruppe").value;
            nameDerUebung = document.getElementById("nameDerUebung").value;

            datum = new Date(document.getElementById("datum").value + "T00:00:00");
            natoDate = formatNATODate(datum, false);

            // **L√∂sungsw√∂rter beim Start auslesen**
            loesungswoerter = {}; // Zur√ºcksetzen

            let option = document.querySelector('input[name="loesungswortOption"]:checked')?.id || "keineLoesungswoerter";

            if (option === "zentralLoesungswort") {
                let zentralesWort = document.getElementById("zentralLoesungswortInput").value.trim();
                if (!zentralesWort) {
                    // Falls leer, zuf√§lliges Wort w√§hlen
                    zentralesWort = predefinedLoesungswoerter[Math.floor(Math.random() * predefinedLoesungswoerter.length)];
                    document.getElementById("zentralLoesungswortInput").value = zentralesWort;
                }
                teilnehmerListe.forEach(teilnehmer => {
                    loesungswoerter[teilnehmer] = zentralesWort;
                });
            } 
            else if (option === "individuelleLoesungswoerter") {
                teilnehmerListe.forEach((teilnehmer, index) => {
                    let individuellesWort = document.getElementById(`loesungswort-${index}`)?.value.trim() || "";
                    loesungswoerter[teilnehmer] = individuellesWort;
                });
            }
            console.log("L√∂sungsw√∂rter:", loesungswoerter);

            if (useCustomList) {
                // Falls der Nutzer eine eigene Datei hochl√§dt
                if (!file) {
                    alert("Bitte eine Funkspruch-Datei hochladen!");
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (event) {
                    let funksprueche = event.target.result.split("\n").filter(s => s.trim() !== "").sort(() => Math.random() - 0.5);
                    generateAllPages(funksprueche);
                };
                reader.readAsText(file);
            } else {
                // Falls der Nutzer die Standard-Liste nutzen will
                fetch("funksprueche.txt") // Datei vom Server laden
                    .then(response => response.text())
                    .then(data => {
                        let funksprueche = data.split("\n").filter(s => s.trim() !== "").sort(() => Math.random() - 0.5);
                        generateAllPages(funksprueche);
                    })
                    .catch(error => console.error("Fehler beim Laden der Funkspruchliste:", error));
            }

            document.getElementById("output-container").style.display = "block";
            document.getElementById("footer").style.display = "block";

        }

        /**
         * Verteilt zuf√§llig Nachrichten an "ALLE" und "MEHRERE", ohne √úberschneidung.
         *
         * @param {number} totalMessages - Gesamtanzahl verf√ºgbarer Nachrichten (z.B. 0..totalMessages-1)
         * @param {number} anzahlAlle    - Wie viele Nachrichten sollen an "ALLE" gehen?
         * @param {number} anzahlMehrere - Wie viele Nachrichten sollen an "MEHRERE" gehen?
         *
         * @returns {{ alle: number[], mehrere: number[] }}
         *    - `alle`: Array mit den Nachrichtennummern, die an "ALLE" gehen
         *    - `mehrere`: Array mit den Nachrichtennummern, die an "MEHRERE" gehen
         */
        function verteileNachrichten(totalMessages, anzahlAlle, anzahlMehrere) {
            // 1) Validierung: Reicht die Gesamtanzahl f√ºr die gew√ºnschten Mengen aus?
            if (anzahlAlle + anzahlMehrere > totalMessages) {
                throw new Error(
                    "Die gew√ºnschte Anzahl f√ºr 'ALLE' und 'MEHRERE' √ºbersteigt die Gesamtanzahl an Nachrichten."
                );
            }

            // 2) Array aller m√∂glichen Nachrichtennummern (0, 1, 2, ..., totalMessages - 1)
            const alleNachrichten = [...Array(Number(totalMessages)).keys()];

            // 3) Zuf√§llig mischen
            alleNachrichten.sort(() => Math.random() - 0.5);
            alleNachrichten.sort(() => Math.random() - 0.5);
            alleNachrichten.sort(() => Math.random() - 0.5);

            // 4) Aufteilen in "ALLE" und "MEHRERE", ohne √úberschneidung
            const nachrichtenFuerAlle = alleNachrichten.slice(0, anzahlAlle);
            const nachrichtenFuerMehrere = alleNachrichten.slice(anzahlAlle, anzahlAlle + anzahlMehrere);
            const nachrichtenEinfach = alleNachrichten.slice(anzahlAlle + anzahlMehrere);

            return {
                alle: nachrichtenFuerAlle,
                mehrere: nachrichtenFuerMehrere,
                einfach: nachrichtenEinfach
            };
        }

        /**
         * Gibt eine zuf√§llige Liste anderer Teilnehmer zur√ºck (mind. 2).
         * 
         * @param {string[]} teilnehmerListe - Gesamte Teilnehmerliste
         * @param {string} aktuellerTeilnehmer - Der Teilnehmer, der "sich selbst" nicht erhalten darf
         * @returns {string[]} Zuf√§lliges Teil-Array (mindestens 2 Teilnehmer)
         */
        function getRandomSubsetOfOthers(teilnehmerListe, aktuellerTeilnehmer) {
            // 1) Filter: Wer ist "nicht ich"?
            const andere = teilnehmerListe.filter(t => t !== aktuellerTeilnehmer);
            const gesamtTeilnehmer = andere.length;

            // 2) Durchmischen
            const gemischt = [...andere].sort(() => Math.random() - 0.5);

            // 3) Gewichtete Wahrscheinlichkeitsverteilung f√ºr Gruppengr√∂√üe
            const minGroesse = 2;
            const maxGroesse = gesamtTeilnehmer;

            // Berechnung einer zuf√§lligen Gr√∂√üe mit einer gewichteten Verteilung:
            // Wahrscheinlichkeit f√ºr kleine Gruppen ist h√∂her, gr√∂√üere Gruppen sind seltener.
            let zufallsGroesse;

            if (Math.random() < 0.7) {
                // 70% Wahrscheinlichkeit f√ºr eine Gruppe bis maximal H√§lfte der Teilnehmer
                zufallsGroesse = Math.floor(Math.random() * (Math.ceil(gesamtTeilnehmer / 2) - minGroesse + 1)) + minGroesse;
            } else {
                // 30% Wahrscheinlichkeit f√ºr eine gr√∂√üere Gruppe bis zur gesamten Liste
                zufallsGroesse = Math.floor(Math.random() * (maxGroesse - minGroesse + 1)) + minGroesse;
            }

            // 4) Den ‚Äûvorderen‚Äú Teil (z. B. 2, 3, ‚Ä¶) zur√ºckgeben
            return gemischt.slice(0, zufallsGroesse);
        }

        /**
         * Gibt einen zuf√§lligen "anderen" Teilnehmer zur√ºck.
         *
         * @param {string[]} teilnehmerListe     - Gesamte Liste aller Teilnehmer
         * @param {string} aktuellerTeilnehmer   - Der Teilnehmer, der sich selbst nicht enthalten darf
         * @returns {string} Ein zuf√§lliger anderer Teilnehmer
         */
        function getRandomOther(teilnehmerListe, aktuellerTeilnehmer) {
            // 1) Filter: Wer ist "nicht ich"?
            const andere = teilnehmerListe.filter(t => t !== aktuellerTeilnehmer);

            // 2) Zuf√§lligen Index bestimmen
            const randomIndex = Math.floor(Math.random() * andere.length);

            // 3) Zur√ºckgeben
            return andere[randomIndex];
        }

        function generiereUebung(funksprueche) {
            spruecheProTeilnehmer--;

            // Generiere √úbung ohne L√∂sungsbuchstaben
            let uebungsDaten = teilnehmerListe.map(teilnehmer => {
                return {
                    teilnehmer,
                    kopfdaten: {
                        datum: natoDate,
                        nameDerUebung: nameDerUebung,
                        leitung: leitung,
                        teilnehmer: teilnehmerListe,
                        rufgruppe: rufgruppe
                    },
                    nachrichten: generiereNachrichten(teilnehmer, funksprueche),
                    loesungswort: loesungswoerter[teilnehmer] || "" // Speichere das L√∂sungswort mit ab
                };
            });

            // Jetzt die L√∂sungsbuchstaben verteilen
            verteileLoesungswoerter(uebungsDaten);

            return uebungsDaten;
        }

        /**
         * Generiert alle Nachrichten f√ºr einen Teilnehmer.
         */
        function generiereNachrichten(teilnehmer, funksprueche) {
            let gemischteFunksprueche = [...funksprueche].sort(() => 0.5 - Math.random());
            let nachrichtenVerteilung = verteileNachrichten(spruecheProTeilnehmer, spruecheAnAlle, spruecheAnMehrere);

            let nachrichten = [];

            // Erste Nachricht: Anmeldung
            nachrichten.push({
                id: 1,
                nachricht: "Ich melde mich in Ihrem Sprechfunkverkehrskreis an.",
                empfaenger: [leitung]
            });

            for (let i = 0; i < spruecheProTeilnehmer; i++) {
                let nachricht = {};
                nachricht.id = i + 2;
                nachricht.nachricht = gemischteFunksprueche[i];

                if (nachrichtenVerteilung.alle.includes(i)) {
                    nachricht.empfaenger = ["Alle"];
                } else if (nachrichtenVerteilung.mehrere.includes(i)) {
                    nachricht.empfaenger = getRandomSubsetOfOthers(teilnehmerListe, teilnehmer);
                } else {
                    nachricht.empfaenger = [getRandomOther(teilnehmerListe, teilnehmer)];
                }
                nachrichten.push(nachricht);
            }

            return nachrichten;
        }

        /**
         * Verteilt die L√∂sungsbuchstaben zuf√§llig auf Nachrichten an den Empf√§nger,
         * aber mit ihrem urspr√ºnglichen Index (+1), damit das Wort zusammengesetzt werden kann.
         */
        function verteileLoesungswoerter(uebungsDaten) {
            uebungsDaten.forEach(empfaengerDaten => {
                let empfaenger = empfaengerDaten.teilnehmer;
                let loesungswort = empfaengerDaten.loesungswort.split(""); // Array der Buchstaben mit Index

                // Speichere den Original-Index f√ºr sp√§tere Rekonstruktion, +1 f√ºr menschliche Lesbarkeit
                let buchstabenMitIndex = loesungswort.map((buchstabe, index) => ({ index: index + 1, buchstabe }));

                // Alle Nachrichten sammeln, die nur f√ºr diesen Teilnehmer bestimmt sind
                let empfaengerNachrichten = [];
                uebungsDaten.forEach(absenderDaten => {
                    if (absenderDaten.teilnehmer !== empfaenger) {
                        absenderDaten.nachrichten.forEach(nachricht => {
                            if (nachricht.empfaenger.length === 1 && nachricht.empfaenger[0] === empfaenger) {
                                empfaengerNachrichten.push(nachricht);
                            }
                        });
                    }
                });

                let anzahlNachrichten = empfaengerNachrichten.length;

                if (anzahlNachrichten === 0) {
                    console.warn(`‚ö† Warnung: Keine Nachrichten f√ºr ${empfaenger} verf√ºgbar!`);
                    return;
                }

                // Falls das L√∂sungswort mehr Buchstaben als Nachrichten hat, m√ºssen mehrere Buchstaben pro Nachricht gesendet werden
                let buchstabenProNachricht = Math.ceil(buchstabenMitIndex.length / anzahlNachrichten);

                // Zuf√§llig mischen, aber mit Index
                buchstabenMitIndex.sort(() => Math.random() - 0.5);

                let buchstabenIndex = 0;

                // Nachrichten zuf√§llig mischen
                let gemischteNachrichten = [...empfaengerNachrichten].sort(() => Math.random() - 0.5);

                // Buchstaben zuf√§llig auf Nachrichten verteilen, aber mit originalem Index (+1 f√ºr menschliche Lesbarkeit)
                gemischteNachrichten.forEach(nachricht => {
                    let buchstabenSegment = [];

                    for (let i = 0; i < buchstabenProNachricht; i++) {
                        if (buchstabenIndex < buchstabenMitIndex.length) {
                            let { index, buchstabe } = buchstabenMitIndex[buchstabenIndex];
                            buchstabenSegment.push(`${index}${buchstabe}`); // Format: "1F"
                            buchstabenIndex++;
                        }
                    }

                    if (buchstabenSegment.length > 0) {
                        nachricht.nachricht += " " + buchstabenSegment.join(""); // Mehrere Buchstaben direkt hintereinander
                    }
                });
            });
        }

        /**
         * Erstellt HTML-Seiten und zeigt sie im iframe mit Paginierung an.
         * 
         * @param {Array} funksprueche - JSON-Array mit den Funkspr√ºchen
         */
        function generateAllPages(funksprueche) {
            jsonUebungsDaten = generiereUebung(funksprueche);
            htmlUebungsDaten = jsonUebungsDaten.map(data => generateHTMLPage(data));
            currentPageIndex = 0;

            if (htmlUebungsDaten.length > 0) {
                displayPage(currentPageIndex);
            }
        }

        /**
         * Zeigt die aktuelle Seite im iframe an.
         */
        function displayPage(index) {
            if (index < 0 || index >= htmlUebungsDaten.length) return;

            const iframe = document.getElementById("resultFrame");
            iframe.srcdoc = htmlUebungsDaten[index]; // L√§dt den HTML-Code direkt in das iframe

            document.getElementById("current-page").textContent = `Seite ${index + 1} / ${htmlUebungsDaten.length}`;
        }

        /**
         * Wechselt zur n√§chsten oder vorherigen Seite.
         * @param {number} step - 1 f√ºr weiter, -1 f√ºr zur√ºck
         */
        function changePage(step) {
            const newIndex = currentPageIndex + step;
            if (newIndex >= 0 && newIndex < htmlUebungsDaten.length) {
                currentPageIndex = newIndex;
                displayPage(currentPageIndex);
            }
        }

        function formatNATODate(date, withTime = true) {
            const monate = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];

            let tag = String(date.getDate()).padStart(2, "0");  // Tag zweistellig
            let stunde = String(date.getHours()).padStart(2, "0"); // Stunden zweistellig
            let minute = String(date.getMinutes()).padStart(2, "0"); // Minuten zweistellig
            let monat = monate[date.getMonth()]; // Monat als 3-Buchstaben-Abk√ºrzung
            let jahr = String(date.getFullYear()).slice(-2); // Zweistellige Jahreszahl

            if (withTime)
                return `${tag}${stunde}${minute}${monat}${jahr}`;
            return `${tag}${monat}${jahr}`;
        }

        /**
         * Erstellt die HTML-Struktur f√ºr eine einzelne √úbungsseite.
         * 
         * @param {Object} teilnehmerDaten - JSON-Objekt f√ºr einen Teilnehmer
         * @returns {string} - HTML-Code als String
         */
        function generateHTMLPage(teilnehmerDaten) {
            const { teilnehmer, kopfdaten, nachrichten, loesungswort } = teilnehmerDaten;

            const teilnehmerListeHTML = kopfdaten.teilnehmer
                .map(name => "<tr><td>" + name + "</td></tr>")
                .join("");

            const nachrichtenHTML = nachrichten
                .map(n => 
                    "<tr>" +
                        "<td>" + n.id + "</td>" +
                        "<td>" + n.empfaenger.join("<br/>").replace(/ /g, "&nbsp;") + "</td>" +
                        "<td>" + n.nachricht + "</td>" +
                    "</tr>")
                .join("");

            return "<!DOCTYPE html>" +
            "<html lang='de'>" +
            "<head>" +
                "<meta charset='UTF-8'>" +
                "<meta name='viewport' content='width=device-width, initial-scale=1.0'>" +
                "<title>Sprechfunk√ºbung - " + teilnehmer + "</title>" +
                "<style>" +
                    "body { font-family: Arial, sans-serif; margin: 20px; }" +
                    ".container { max-width: 100%; margin: auto; }" +
                    "h1, h2 { text-align: center; }" +
                    "h1 { font-size: 22px; font-weight: bold; }" +
                    "h2 { font-size: 18px; font-weight: bold; }" +
                    "table { width: 100%; border-collapse: collapse; margin-top: 20px; }" +
                    "th, td { border: 1px solid black; padding: 8px; text-align: left; }" +
                    "th { background-color: #f2f2f2; }" +
                    ".row { display: flex; justify-content: space-between; margin-top: 20px; }" +
                    ".col { width: 48%; }" +
                    "@media (max-width: 768px) {" +
                        ".row { flex-direction: column; }" +
                        ".col { width: 100%; margin-bottom: 15px; }" +
                    "}" +
                "</style>" +
            "</head>" +
            "<body>" +
                "<div class='container'>" +
                    "<h1>Sprechfunk√ºbung " + kopfdaten.nameDerUebung + "</h1>" +
                    "<h2>Eigener Funkrufname: " + teilnehmer + "</h2>" +

                    "<div class='row'>" +
                        "<div class='col'>" +
                            "<h3>Kopfdaten</h3>" +
                            "<table>" +
                                "<tr><th>Datum</th><td>" + kopfdaten.datum + "</td></tr>" +
                                "<tr><th>Rufgruppe</th><td>" + kopfdaten.rufgruppe + "</td></tr>" +
                                "<tr><th>Betriebsleitung</th><td>" + kopfdaten.leitung + "</td></tr>" +
                                "<tr><th>L√∂sungswort</th><td>" + loesungswort + "</td></tr>" +
                            "</table>" +
                        "</div>" +

                        "<div class='col'>" +
                            "<h3>Teilnehmer</h3>" +
                            "<table>" +
                                teilnehmerListeHTML +
                            "</table>" +
                        "</div>" +
                    "</div>" +

                    "<h3>Folgende Nachrichten sind zu √ºbermitteln:</h3>" +
                    "<table>" +
                        "<thead>" +
                            "<tr>" +
                                "<th style='width: 10%;'>Nr.</th>" +
                                "<th style='width: 20%;'>Empf√§nger</th>" +
                                "<th style='width: 70%;'>Nachrichtentext</th>" +
                            "</tr>" +
                        "</thead>" +
                        "<tbody>" +
                            nachrichtenHTML +
                        "</tbody>" +
                    "</table>" +
                "</div>" +
            "</body>" +
            "</html>";
        }


        function fixEncoding(text) {
            return text.normalize("NFC") // Korrigiert Zeichensatz-Probleme
                .replace(/ /g, "\u00A0"); // Non-Breaking Space f√ºr Leerzeichen
        }

        async function generatePDFs() {
            const { jsPDF } = window.jspdf;
            const softwareVersion = "1.0.0"; // Versionsnummer hier anpassen
            const generierungszeit = formatNATODate(new Date()); // NATO-Datum f√ºr Fu√üzeile

            for (let i = 0; i < jsonUebungsDaten.length; i++) {
                const teilnehmerDaten = jsonUebungsDaten[i];
                const participant = fixEncoding(teilnehmerDaten.teilnehmer);
                const kopfdaten = teilnehmerDaten.kopfdaten;

                let pdf = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const pageMargin = 10;
                const firstTableStartY = 30;
                const secondPageTableTopMargin = 30; // **Garantierter Abstand f√ºr die Tabelle auf Seite 2+**

                // **1. Kopfzeile f√ºr erste Seite**
                drawFirstPageHeader(pdf, kopfdaten, participant, pdfWidth);

                // **2. Kopfdaten-Tabelle (links)**
                let kopfdatenWidth = (pdfWidth - 2 * pageMargin) * 0.35;
                drawKopfdatenTable(pdf, kopfdaten, firstTableStartY, pageMargin, kopfdatenWidth);

                // **3. Teilnehmerliste (rechts)**
                let teilnehmerWidth = (pdfWidth - 2 * pageMargin) * 0.60;
                drawTeilnehmerTable(pdf, kopfdaten, firstTableStartY, pdfWidth - pageMargin - teilnehmerWidth, teilnehmerWidth);

                // **4. Nachrichten-Tabelle**
                let tableStartY = Math.max(pdf.lastAutoTable.finalY + 10, 75);
                drawNachrichtenTable(pdf, teilnehmerDaten, tableStartY, pageMargin, pdfWidth, secondPageTableTopMargin);

                // **5. Setze Kopfzeilen & Seitenzahlen auf allen Seiten**
                let totalPages = pdf.internal.getNumberOfPages();
                for (let j = 1; j <= totalPages; j++) {
                    pdf.setPage(j);
                    drawHeader(pdf, participant, j, pdfWidth, pageMargin, kopfdaten);
                    drawFooter(pdf, generierungszeit, softwareVersion, j, totalPages, pdfWidth, pdfHeight, pageMargin);
                }

                // **6. PDF speichern**
                pdf.save(`${participant}.pdf`);
            }

            alert("Alle PDFs wurden erfolgreich erstellt!");
        }

        /**
         * Erstellt die Kopfzeile der ersten Seite (gr√∂√üer & fett).
         */
        function drawFirstPageHeader(pdf, kopfdaten, participant, pdfWidth) {
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(16);
            pdf.text(`${kopfdaten.nameDerUebung}`, pdfWidth / 2, 15, { align: "center" });

            pdf.setFontSize(14);
            pdf.text(`${participant}`, pdfWidth / 2, 20, { align: "center" });
        }

        /**
         * Erstellt die Kopfzeile auf Seite 2+.
         */
        function drawHeader(pdf, participant, pageNumber, pdfWidth, pageMargin, kopfdaten) {
            if (pageNumber > 1) {
                pdf.setFont("helvetica", "normal");
                pdf.setFontSize(10);

                // **Links: Funkrufname**
                pdf.text(`Eigener Funkrufname: ${participant}`, pageMargin, 20);

                // **Rechts: Name der √úbung**
                let rightText = kopfdaten.nameDerUebung + " " + kopfdaten.datum
                let nameWidth = pdf.getTextWidth(rightText);
                pdf.text(rightText, pdfWidth - pageMargin - nameWidth, 20);

                // **Trennlinie unter der Kopfzeile**
                pdf.setDrawColor(0);
                pdf.line(pageMargin, 22, pdfWidth - pageMargin, 22);
            }
        }

        /**
         * Erstellt die Fu√üzeile auf allen Seiten.
         */
        function drawFooter(pdf, generierungszeit, softwareVersion, pageNumber, totalPages, pdfWidth, pdfHeight, pageMargin) {
            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(10);

            // **Seitenzahl bleibt auf allen Seiten gleich formatiert**
            let pageNumberText = `Seite ${pageNumber} von ${totalPages}`;
            let pageNumberWidth = pdf.getTextWidth(pageNumberText);
            pdf.text(pageNumberText, pdfWidth - pageMargin - pageNumberWidth, pdfHeight - 10);

            // **Link und Copyright-Infos linksb√ºndig**
            let leftText = `¬© Johannes Rudolph | Version ${softwareVersion} | Generiert: ${generierungszeit} | Generator: wattnpapa.github.io/sprechfunk-uebung`;
            pdf.textWithLink(leftText, pageMargin, pdfHeight - 10, { url: "https://wattnpapa.github.io/sprechfunk-uebung/" });
        }

        /**
         * Erstellt die Kopfdaten-Tabelle.
         */
        function drawKopfdatenTable(pdf, kopfdaten, startY, marginLeft, width) {
            pdf.autoTable({
                head: [["Beschreibung", "Wert"]],
                body: [
                    ["Datum", kopfdaten.datum],
                    ["Rufgruppe", kopfdaten.rufgruppe],
                    ["Betriebsleitung", kopfdaten.leitung]
                ],
                startY: startY,
                margin: { left: marginLeft },
                tableWidth: width,
                theme: "grid",
                styles: { fontSize: 10, cellPadding: 3, lineWidth: 0.5 },
                headStyles: { fillColor: [200, 200, 200] }
            });
        }

        /**
         * Erstellt die Teilnehmerliste-Tabelle.
         */
        function drawTeilnehmerTable(pdf, kopfdaten, startY, marginLeft, width) {
            let teilnehmerColumns = 2;
            let teilnehmerRows = Math.ceil(kopfdaten.teilnehmer.length / teilnehmerColumns);
            let teilnehmerTable = [];

            for (let r = 0; r < teilnehmerRows; r++) {
                let row = [];
                for (let c = 0; c < teilnehmerColumns; c++) {
                    let index = r + c * teilnehmerRows;
                    if (index < kopfdaten.teilnehmer.length) {
                        row.push(kopfdaten.teilnehmer[index]);
                    } else {
                        row.push("");
                    }
                }
                teilnehmerTable.push(row);
            }

            pdf.autoTable({
                head: [["Teilnehmer", ""]],
                body: teilnehmerTable,
                startY: startY,
                margin: { left: marginLeft },
                tableWidth: width,
                theme: "grid",
                styles: { fontSize: 10, cellPadding: 3, lineWidth: 0.5 },
                headStyles: { fillColor: [200, 200, 200] }
            });
        }

        /**
         * Erstellt die Nachrichten-Tabelle.
         */
        function drawNachrichtenTable(pdf, teilnehmerDaten, startY, marginLeft, pdfWidth, secondPageTableTopMargin) {
            let tableWidth = pdfWidth - 2 * marginLeft;
            let empfaengerWidth = tableWidth * 0.20;
            let lfdnrWidth = 12;
            let columnWidths = [lfdnrWidth, empfaengerWidth, tableWidth - lfdnrWidth - empfaengerWidth];

            pdf.autoTable({
                head: [["Nr.", "Empf√§nger", "Nachrichtentext"]],
                body: teilnehmerDaten.nachrichten.map(n => [n.id, n.empfaenger.join("\n"), n.nachricht]),
                startY: startY,
                theme: "grid",
                margin: { left: marginLeft, top: secondPageTableTopMargin },
                tableWidth: tableWidth,
                columnStyles: {
                    0: { cellWidth: columnWidths[0] },
                    1: { cellWidth: columnWidths[1] },
                    2: { cellWidth: columnWidths[2] }
                },
                styles: { fontSize: 10, cellPadding: 3, lineWidth: 0.5 },
                headStyles: { fillColor: [200, 200, 200] }
            });
        }

        // Funktion zum Umschalten der L√∂sungswort-Optionen
        function toggleLoesungswortOption() {
            let option = document.querySelector('input[name="loesungswortOption"]:checked').value;
            
            document.getElementById("zentralesLoesungswortContainer").style.display = option === "gleich" ? "block" : "none";
            
            // Zeigt/hide die L√∂sungswort-Spalte in der Teilnehmerliste
            document.getElementById("loesungswortColumn").style.display = option === "individuell" ? "table-cell" : "none";
            
            // Aktualisiert die Teilnehmerliste mit L√∂sungsw√∂rtern (falls ben√∂tigt)
            renderTeilnehmer();
        }

        async function generateInstructorPDF() {
            const { jsPDF } = window.jspdf;
            let pdf = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const pageMargin = 10;
            const firstTableStartY = 30;
            const secondPageTableTopMargin = 30; // **Garantierter Abstand f√ºr Tabellen auf Seite 2+**
            const softwareVersion = "1.0.0";
            const generierungszeit = formatNATODate(new Date());

            // **1. Kopfzeile f√ºr erste Seite**
            drawFirstPageHeader(pdf, jsonUebungsDaten[0].kopfdaten, "√úbungsleitung", pdfWidth);

            // **2. Kopfdaten-Tabelle**
            drawKopfdatenTable(pdf, jsonUebungsDaten[0].kopfdaten, firstTableStartY, pageMargin, ((pdfWidth - 2 * pageMargin) / 2));

            // **3. Teilnehmer-Tabelle**
            let tableStartY = Math.max(pdf.lastAutoTable.finalY + 10, 75);

            let tableBody = jsonUebungsDaten.map(t => [
                t.teilnehmer,
                "", // Platz f√ºr Anmeldezeitpunkt
                t.loesungswort ? t.loesungswort : "", // Falls es ein L√∂sungswort gibt
                "" // Bemerkungen (handschriftlich eintragbar)
            ]);

            let columnWidths = [40, 35, 50, 150]; // Anpassung f√ºr saubere Darstellung

            pdf.autoTable({
                head: [["Teilnehmer", "Anmeldung", "L√∂sungswort", "Bemerkungen"]],
                body: tableBody,
                startY: tableStartY,
                theme: "grid",
                margin: { left: pageMargin, top: secondPageTableTopMargin },
                tableWidth: pdfWidth - 2 * pageMargin,
                columnStyles: {
                    0: { cellWidth: columnWidths[0] },
                    1: { cellWidth: columnWidths[1] },
                    2: { cellWidth: columnWidths[2] },
                    3: { cellWidth: columnWidths[3] }
                },
                styles: { fontSize: 10, cellPadding: 3, lineWidth: 0.5 },
                headStyles: { fillColor: [200, 200, 200] }
            });

            // **4. Kopf- und Fu√üzeilen f√ºr alle Seiten**
            let totalPages = pdf.internal.getNumberOfPages();
            for (let j = 1; j <= totalPages; j++) {
                pdf.setPage(j);
                drawHeader(pdf, "√úbungsleitung", j, pdfWidth, pageMargin, jsonUebungsDaten[0].kopfdaten);
                drawFooter(pdf, generierungszeit, softwareVersion, j, totalPages, pdfWidth, pdfHeight, pageMargin);
            }

            pdf.save("Uebungsleitung.pdf");
        }


        function setLoesungswoerter() {
            const isKeine = document.getElementById("keineLoesungswoerter").checked;
            const isZentral = document.getElementById("zentralLoesungswort").checked;
            const isIndividuell = document.getElementById("individuelleLoesungswoerter").checked;

            if (isKeine) {
                // L√∂sungsw√∂rter zur√ºcksetzen
                loesungswoerter = {};
                document.getElementById("zentralLoesungswortInput").disabled = true;
                document.getElementById("zentralLoesungswortInput").value = "";
                document.getElementById("shuffleButton").disabled = true;
            } else if (isZentral) {
                // Zentrales L√∂sungswort setzen
                let zentralesWort = document.getElementById("zentralLoesungswortInput").value;
                teilnehmerListe.forEach(teilnehmer => {
                    loesungswoerter[teilnehmer] = zentralesWort;
                });

                // Eingabefeld aktivieren
                document.getElementById("zentralLoesungswortInput").disabled = false;
                document.getElementById("shuffleButton").disabled = true;
            } else if (isIndividuell) {
                // Individuelle W√∂rter zuweisen
                assignRandomLoesungswoerter();
                document.getElementById("zentralLoesungswortInput").disabled = true;
                document.getElementById("shuffleButton").disabled = false;
            }

            renderTeilnehmer(); // UI aktualisieren
        }

        function assignRandomLoesungswoerter() {
            // Shuffle-Algorithmus f√ºr zuf√§llige Verteilung
            let shuffledWords = [...predefinedLoesungswoerter].sort(() => Math.random() - 0.5);

            teilnehmerListe.forEach((teilnehmer, index) => {
                loesungswoerter[teilnehmer] = shuffledWords[index % shuffledWords.length];
            });
        }

        function shuffleLoesungswoerter() {
            const isZentral = document.getElementById("zentralLoesungswort").checked;
            const isIndividuell = document.getElementById("individuelleLoesungswoerter").checked;

            if (isZentral) {
                let zentralesWort = predefinedLoesungswoerter[Math.floor(Math.random() * predefinedLoesungswoerter.length)];
                document.getElementById("zentralLoesungswortInput").value = zentralesWort;
                teilnehmerListe.forEach(teilnehmer => {
                    loesungswoerter[teilnehmer] = zentralesWort;
                });
            } else if (isIndividuell) {
                assignRandomLoesungswoerter();
            }

            renderTeilnehmer(false); // WICHTIG: Setze `triggerShuffle = false`, um Endlosschleife zu vermeiden
        }

        renderInitData();
    </script>

    <footer id="footer" class="text-center mt-4" style="display: none;">
        <p>¬© Johannes Rudolph | Version 1.0.0 |
            <a href="https://wattnpapa.github.io/sprechfunk-uebung/" target="_blank">Generator</a> |
            <a href="https://github.com/wattnpapa/sprechfunk-uebung" target="_blank">GitHub-Repository</a>
        </p>
    </footer>

</body>

</html>